apiVersion: kyverno.io/v2beta1
kind: ClusterPolicy
metadata:
  annotations:
    policies.kyverno.io/category: Gateway API
    policies.kyverno.io/description: This policy ensures that any Gateway resource references a gatewayClassName that exists in the cluster.
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Gateway, GatewayClass
    policies.kyverno.io/title: Check Gateway Class Exists
  name: check-gateway-class-exists
spec:
  background: true
  rules:
    - context:
        - apiCall:
            jmesPath: items[].metadata.name
            urlPath: /apis/gateway.networking.k8s.io/v1alpha2/gatewayclasses
          name: gatewayClasses
      match:
        any:
          - resources:
              kinds:
                - Gateway
      name: validate-gateway-class
      validate:
        deny:
          conditions:
            all:
              - key: '{{ request.object.spec.gatewayClassName }}'
                operator: AnyNotIn
                value: '{{ gatewayClasses }}'
        message: "The gatewayClassName '{{ request.object.spec.gatewayClassName }}' does not exist in the cluster. Please specify an existing GatewayClass."
  validationFailureAction: Enforce