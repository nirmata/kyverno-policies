apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: check-istio-deprecated-telemetry
  annotations:
    policies.kyverno.io/title: Check for Deprecated Istio Telemetry Configuration
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: IstioOperator
    policies.kyverno.io/description: >-
      This policy checks if IstioOperator resources use the deprecated telemetry.v2.prometheus.configOverride
      field in MeshConfig. Istio now provides a dedicated Telemetry API for better customization of
      metrics, traces, and access logs. Users should migrate telemetry configuration to the Telemetry API.
spec:
  validationFailureAction: audit
  background: true
  rules:
    - name: check-istio-telemetry-config
      match:
        any:
        - resources:
            kinds:
              - IstioOperator
      validate:
        message: "Using MeshConfig for telemetry configuration is deprecated. Please migrate to the Telemetry API for enhanced flexibility."
        deny:
          conditions:
            - key: "{{ has(request.object.spec.meshConfig, 'telemetry') && has(request.object.spec.meshConfig.telemetry, 'v2') && has(request.object.spec.meshConfig.telemetry.v2, 'prometheus') && has(request.object.spec.meshConfig.telemetry.v2.prometheus, 'configOverride') }}"
              operator: "equals"
              value: true