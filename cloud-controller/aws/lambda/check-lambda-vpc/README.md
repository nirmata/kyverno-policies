# Check Lambda VPC

By default, Lambda functions run in a Lambda-managed VPC that has internet access. To access resources in a VPC in your account, you can add a VPC configuration to a function. This restricts the function to resources within that VPC, unless the VPC has internet access. Running Lambda functions within a VPC provides better isolation and control over network access.

## Policy Details:

- **Policy Name:** Check Lambda VPC
- **Check Description:** This Policy validates that VPCConfig must be present for the Lambda function
- **Policy Category:** AWS Lambda Best Practices

### Policy Validation Testing Instructions

For testing this policy you will need to:
- Make sure you have `cloud-scanner` installed on the machine 
- Properly authenticate with AWS

1. **Set up for the Lambda Function:**

    a. Create a `lambda_function.py` file with the following code:
    ```python
    def lambda_handler(event, context):
        return {
            'statusCode': 200,
            'body': 'Hello, world!'
        }
    ```

    b. Store the above python file in a zip file `lambda-code.zip`

    c. Create an S3 bucket and upload the zip file

2. **Create Lambda Functions:**

    Good Lambda Function
    ```bash
    aws lambda create-function \
    --function-name GoodLambdaFunction \
    --runtime python3.8 \
    --role arn:aws:iam::xxxxx:role/test-lambda-execution-role-01 \
    --handler lambda_function.lambda_handler \
    --code S3Bucket=test-bucket-lambda-function-01,S3Key=lambda-code.zip \
    --vpc-config SubnetIds=subnet-id-1,SecurityGroupIds=sg-1
    ```
    Substitute `subnet-id-1` and `sg-1` accordingly

    NOTE - This step will fail if you have applied the policy as a result of Admission Controller.

    Bad Lambda Function
    ```bash
    aws lambda create-function \
    --function-name BadLambdaFunction \
    --runtime python3.8 \
    --role arn:aws:iam::xxxxx:role/test-lambda-execution-role-01 \
    --handler lambda_function.lambda_handler \
    --code S3Bucket=test-bucket-lambda-function-01,S3Key=lambda-code.zip
    ```

3. **Get the Payloads:**

    Good Payload
    ```bash
    aws cloudcontrol get-resource  --type-name AWS::Lambda::Function --profile devtest-sso --identifier GoodLambdaFunction | jq '.ResourceDescription.Properties |= fromjson'
    ```
    Bad Payload
    ```bash
    aws cloudcontrol get-resource  --type-name AWS::Lambda::Function --profile devtest-sso --identifier BadLambdaFunction | jq '.ResourceDescription.Properties |= fromjson'
    ```

## Test the Policy with Cloud Scanner:

a. **Apply the Policy after making the appropriate AWS resources:**

```
kubectl apply -f ./check-lambda-vpc.yaml
```


b. **Check the Report Generated by Cloud Scanner:**

```
kubectl get clusterpolicyreport
```


```
NAME                                                              KIND             NAME                             PASS   FAIL   WARN   ERROR   SKIP      AGE
65dce8b586794a7ec90e54d03f32a339e1a7cfbfffa115f732d8a78382c3f5f   LambdaFunction   GoodLambdaFunction                 1      0      0      0       0      7m54s
65dce8b586794a7ec90e54d03f32a339e1a7cfbfffa115f732d8a78382c3asd   LambdaFunction   BadLambdaFunction                  0      1      0      0       0      7m54s

```

---