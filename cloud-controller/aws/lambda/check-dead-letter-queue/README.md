# Check Dead Letter Queue Config

Dead Letter Queues (DLQs) allow Lambda functions to be set up with an SQS queue or SNS topic to capture information about failed asynchronous requests. When a Lambda function's processing fails and the request has exhausted its retries, the Lambda service can store details of the failed request to the configured DLQ. These failed messages can then be examined to determine the cause of failures.

## Policy Details:

-   **Policy Name:** check-dead-letter-queue-config
-   **Check Description:** This policy ensures that AWS Lambda function is configured for a Dead Letter Queue(DLQ)
-   **Policy Category:** AWS Lambda Best Practices

## Policy Validation Testing Instructions

For testing this policy you will need to:

-   Make sure you have `cloud-scanner` installed on the machine
-   Properly authenticate with AWS

1. **Set up for the Lambda Function:**

    a. Create a `lambda_function.py` file with the following code:

    ```python
    def lambda_handler(event, context):
        return {
            'statusCode': 200,
            'body': 'Hello, world!'
        }
    ```

    b. Store the above python file in a zip file `lambda-code.zip`
2. **Create an IAM Role for Lambda:**
    ```bash
    aws iam create-role \
    --role-name <RoleName> \
    --assume-role-policy-document '{
        "Version": "2012-10-17",
        "Statement": [
        {
            "Action": "sts:AssumeRole",
            "Principal": {
            "Service": "lambda.amazonaws.com"
            },
            "Effect": "Allow",
            "Sid": ""
        }
        ]
    }'
    ```
3. **Create an IAM Policy for Lambda:**
    ```bash
    aws iam create-policy \
    --policy-name aws_iam_policy_for_terraform_aws_lambda_role \
    --policy-document '{
        "Version": "2012-10-17",
        "Statement": [
        {
            "Action": [
            "logs:CreateLogGroup",
            "logs:CreateLogStream",
            "logs:PutLogEvents"
            ],
            "Resource": "arn:aws:logs:*:*:*",
            "Effect": "Allow"
        }
        ]
    }'
    ```
4. **Attach the Policy to the IAM Role:**

    a. Retrieve the ARN of the created policy:
    ```bash
    aws iam list-policies --query "Policies[?PolicyName=='aws_iam_policy_for_terraform_aws_lambda_role'].Arn" --output text
    ```
    b. Use the ARN to attach the policy to the IAM role:
    ```bash
    aws iam attach-role-policy \
    --role-name Spacelift_Test_Lambda_Function_Role \
    --policy-arn <POLICY_ARN>
    ```
5. **Create Lambda Functions:**


    Good Lambda Function
    ```bash
    aws lambda create-function \
    --function-name GoodLambdaFunction \
    --runtime python3.8 \
    --role arn:aws:iam::<ACCOUNT_ID>:role/<RoleName>> \
    --handler index.lambda_handler \
    --zip-file fileb://lambda_function.zip \
    ```

    NOTE - This step will fail if you have applied the policy as a result of Admission Controller.

    Bad Lambda Function
    ```bash
     aws lambda create-function \
     --function-name BadLambdaFunction \
     --runtime python3.8 \
     --role arn:aws:iam::<ACCOUNT_ID>:role/<RoleName>> \
     --handler index.lambda_handler \
     --zip-file fileb://lambda_function.zip
    ```

6. **Set Dead Letter Config:**

    Create the queue to be added in the Lambda Function

    ```bash
    aws sqs create-queue --queue-name queue_for_lambda
    ```

    ```bash
    aws lambda update-function-configuration \
        --function-name GoodLambdaFunction \
        --dead-letter-config TargetArn=arn:aws:sqs:us-west-2:<ACCOUNT_ID>:queue_for_lambda
    ```

7. **Get the Payloads:**

    Good Payload
    ```bash
    aws cloudcontrol get-resource  --type-name AWS::Lambda::Function --profile devtest-sso --identifier GoodLambdaFunction | jq '.ResourceDescription.Properties |= fromjson'
    ```
    Bad Payload
    ```bash
    aws cloudcontrol get-resource  --type-name AWS::Lambda::Function --profile devtest-sso --identifier BadLambdaFunction | jq '.ResourceDescription.Properties |= fromjson'
    ```


## Test the Policy with Cloud Scanner:

a. **Apply the Policy after making the appropriate AWS resources:**

```
kubectl apply -f ./check-dead-letter-queue.yaml
```


b. **Check the Report Generated by Cloud Scanner:**

```
kubectl get clusterpolicyreport
```


```
NAME                                                              KIND             NAME                             PASS   FAIL   WARN   ERROR   SKIP      AGE
65dce8b586794a7ec90e54d03f32a339e1a7cfbfffa115f732d8a78382c3f5f   LambdaFunction   GoodLambdaFunction                 1      0      0      0       0      7m54s
65dce8b586794a7ec90e54d03f32a339e1a7cfbfffa115f732d8a78382c3asd   LambdaFunction   BadLambdaFunction                  0      1      0      0       0      7m54s

```

---